<div class="container">
  <div class="row">
    <div class="col s9">
      <h2><%= current_channel.title %></h2>
    </div>
    <div class="col s3">
        <br>
        <%= admin_button %>
    </div>
  </div>
  <%= image_tag current_channel.image, class: 'responsive-img' %>
  <p><%= current_channel.description %></p>

  <br>

  <div class="row">
    <div class="col s12">
      <% if current_user && current_user.subscribed?(current_channel) %>
        <%= link_to 'Continue', '#', class: 'waves-effect waves-light btn right' %>
      <% else %>
        <% if current_channel.free? %>
          <p class="left">FREE</p>
          <%= link_to 'Get Started', channel_subscriptions_path(current_channel), class: 'waves-effect waves-light btn right', method: :post %>
        <% else %>
          <p class="left"><%= number_to_currency current_channel.cost %></p>
          <%= form_tag channel_subscriptions_path(current_channel) do %>
            <script src="https://checkout.stripe.com/checkout.js"></script>

            <button id="customButton" class="waves-effect waves-light btn right">Get Started</button>

            <script>
            var handler = StripeCheckout.configure({
              key: '<%= Rails.configuration.stripe[:publishable_key] %>',
              locale: 'auto',
              token: function(response) {
                var tokenInput = $("<input type=hidden name=stripeToken />").val(response.id);
                var emailInput = $("<input type=hidden name=stripeEmail />").val(response.email);
                $("form").append(tokenInput).append(emailInput).submit();
              }
            });

            document.getElementById('customButton').addEventListener('click', function(e) {
              // Open Checkout with further options:
              handler.open({
                name: '<%= current_channel.title %> (<%= number_to_currency current_channel.cost %>)',
                zipCode: true,
                amount: <%= (current_channel.cost * 100).to_i %>
              });
              e.preventDefault();
            });

            // Close Checkout on page navigation:
            window.addEventListener('popstate', function() {
              handler.close();
            });
            </script>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <% if flash[:alert] %>
    <div class="row">
      <div class="col s12">
        <div class="card-panel valign-wrapper red-text red lighten-4">
          <i class="material-icons">error_outline</i>
          &nbsp;
          <%= flash[:alert] %>
        </div>
      </div>
    </div>
  <% end %>

  <ul class="collection">
    <% current_channel.playlists.rank(:row_order).each do |playlist| %>
      <li class="collection-item">
        <h5 class="title"><%= playlist.title %></h5>
          <div class="collection video-links">
            <div class="divider"></div>
            <% playlist.videos.rank(:row_order).each do |video| %>
              <%= link_to video_path(video), class: "collection-item" do %>
                <div class="section video-link">
                  <h6><b><%= video.title %></b></h6>
                  <span class="truncate"><%= video.description %></span>
                </div>
              <% end %>
            <% end %>
          </div>
      </li>
    <% end %>
  </ul>

</div>
